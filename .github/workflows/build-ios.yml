name: Build iOS App

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'Laileme/**'

jobs:
  build:
    runs-on: macos-14
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show environment
        run: |
          sw_vers
          xcodebuild -version

      - name: Create Package.swift
        run: |
          cat > Package.swift << 'EOF'
          // swift-tools-version: 5.9
          import PackageDescription
          let package = Package(
              name: "Laileme",
              platforms: [.iOS(.v17)],
              dependencies: [],
              targets: [
                  .executableTarget(
                      name: "Laileme",
                      path: "Laileme",
                      exclude: ["Info.plist"]
                  )
              ]
          )
          EOF

      - name: Build for iOS Simulator
        run: |
          xcodebuild build \
            -scheme Laileme \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
            -derivedDataPath ./build \
            -skipPackagePluginValidation \
            CODE_SIGN_IDENTITY=- \
            CODE_SIGNING_ALLOWED=NO \
            2>&1 | tail -50

          echo "=== Build products ==="
          find ./build -name "*.app" -type d 2>/dev/null
          find ./build -name "Laileme" -type f 2>/dev/null | head -5

      - name: Package build artifacts
        if: success()
        run: |
          APP_PATH=$(find ./build -name "*.app" -type d | head -1)
          if [ -n "$APP_PATH" ]; then
            echo "Found app: $APP_PATH"
            mkdir -p artifacts
            cp -R "$APP_PATH" artifacts/
            cd artifacts && zip -r ../Laileme-Simulator.zip . && cd ..
            ls -lh Laileme-Simulator.zip
          else
            echo "No .app found, packaging build dir..."
            PROD_PATH=$(find ./build -path "*/Debug-iphonesimulator/*" -type d | head -1)
            if [ -n "$PROD_PATH" ]; then
              mkdir -p artifacts
              cp -R "$PROD_PATH"/* artifacts/ 2>/dev/null || true
              cd artifacts && zip -r ../Laileme-Build.zip . && cd ..
              ls -lh Laileme-Build.zip
            else
              echo "No build products found"
              find ./build -type f -name "Laileme*" | head -10
            fi
          fi

      - name: Upload artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Laileme-iOS-Build
          path: |
            Laileme-Simulator.zip
            Laileme-Build.zip
          retention-days: 30
          if-no-files-found: warn

      - name: Build summary
        if: always()
        run: |
          echo "=== Build Summary ==="
          echo "Status: ${{ job.status }}"
          echo "Build products:"
          find ./build -name "*.app" -type d 2>/dev/null || echo "No .app found"
          du -sh ./build 2>/dev/null || true
